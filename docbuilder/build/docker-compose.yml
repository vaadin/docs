version: "3"

services:
  docs-app:
    image: vaadin/docbuilder:latest
    working_dir: /docs-app
    environment:
      - DOCS_ARTICLES_PATH=${DOCS_ARTICLES_PATH}
      - DOCS_PATH_PREFIX=${DOCS_PATH_PREFIX}
      - DOCS_EXAMPLES_INCLUDE_URL_PREFIX=${DOCS_PATH_PREFIX}/vaadin/web-component
      - DOCS_VAADIN_CONNECT_PREFIX=${DOCS_PATH_PREFIX}/connect
      - DOCS_TITLE=${DOCS_TITLE}
      - DOCS_VERSIONS_URL=${DOCS_VERSIONS_URL}
      - DOCS_SITE_URL=${DOCS_SITE_URL}
    command: "sh -c '[ -f /root/.vaadin/proKey ] && (npm run build && cp -r /docs-app/public /out/) || echo \"Invalid Vaadin license file!\"'"
    volumes:
      - docbuilder-maven:/root/.m2
      - docbuilder-gatsby-cache:/docs-app/.cache
      - docbuilder-gatsby-public:/docs-app/public
      - ../..:/docs
      - ./out:/out
      - ~/.vaadin/proKey:/root/.vaadin/proKey

  docs:
    image: vaadin/docbuilder:latest
    working_dir: /docs
    command: "sh -c 'mvn clean package -DskipTests -Pproduction && cp -r /docs/target/*.jar /out/'"
    volumes:
      - docbuilder-maven:/root/.m2
      - docbuilder-vaadin-node-modules:/root/.vaadin/node_modules
      - ./out:/out
      - ../..:/docs

volumes:
  docbuilder-maven:
  docbuilder-gatsby-cache:
  docbuilder-gatsby-public:
  docbuilder-vaadin-node-modules:
