name: Style
on:
  pull_request:

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout scripts directory
        uses: actions/checkout@v4
        with:
          repository: vaadin/docs
          path: .
          sparse-checkout: scripts/

      - uses: actions4gh/setup-gh@v1.0.2

      - name: Fetch changes and review them
        id: review
        run: |
          # Temp file for OpenAI API response
          RESPONSE_FILE=$(mktemp)

          # Run style-check, write full response to file
          ./scripts/style-check/style-check.sh \
            "${{ github.event.pull_request.number }}" \
            "${{ github.repository }}" \
            > "$RESPONSE_FILE" || exit 1

          # Extract only the text content safely via jq
          RESULT=$(jq -r '.choices[0].message.content // empty' "$RESPONSE_FILE")

          # Expose result through output *only if small enough*
          # GitHub Actions has a strict limit of ~64 KB
          if [ -n "$RESULT" ]; then
            # Write to output
            {
              echo "result<<EOF"
              echo "$RESULT"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_TOKEN }}
        shell: bash

      - if: ${{ success() }}
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: AI Language Review

      - if: ${{ success() && steps.review.outputs.result }}
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## AI Language Review
            ${{ steps.review.outputs.result }}

      - if: ${{ success() && steps.fc.outputs.comment-id && !steps.review.outputs.result }}
        run: gh api --method DELETE \
          /repos/${{ github.repository }}/issues/comments/${{ steps.fc.outputs.comment-id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
