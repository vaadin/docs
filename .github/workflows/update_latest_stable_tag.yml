name: Update latest_stable tag

on:
  push:
    branches:
      - 'v[0-9]+.[0-9]+'

jobs:
  update-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update latest_stable tag if on highest version branch
        run: |
          LATEST_BRANCH=$(git branch -r | grep -oE 'v[0-9]+\.[0-9]+' | sort -t. -k1 -k2 -n | tail -1)
          
          if [ "${{ github.ref_name }}" == "$LATEST_BRANCH" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -f latest_stable
            git push -f origin latest_stable
            echo "Moved 'latest_stable' tag to ${{ github.sha }}"
          fi
