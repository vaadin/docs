import type { CSSResultGroup } from 'lit';
import auraCss from '@vaadin/aura/aura.css?inline';
import lumoCss from '@vaadin/vaadin-lumo-styles/lumo.css?inline';
import docsCss from 'Frontend/themes/docs/styles.css?inline';

function createStylesheet(css: CSSResultGroup | string): CSSStyleSheet {
  const stylesheet = new CSSStyleSheet();
  // CSS imported with ?inline is actually a string in DSP, but typed as CSSResultGroup due to TS
  // types generated by Flow.
  // eslint-disable-next-line @typescript-eslint/no-base-to-string
  stylesheet.replaceSync(css.toString());
  return stylesheet;
}

const lumoStyleSheet = createStylesheet(lumoCss);
const auraStyleSheet = createStylesheet(auraCss);
const docsStyleSheet = createStylesheet(docsCss);

function updateTheme(root: ShadowRoot) {
  root.adoptedStyleSheets = root.adoptedStyleSheets.filter(
    (styleSheet) => ![lumoStyleSheet, auraStyleSheet, docsStyleSheet].includes(styleSheet)
  );

  const theme = (root.host.getAttribute('theme') ?? '').split(' ');
  if (theme.includes('aura')) {
    root.adoptedStyleSheets.push(auraStyleSheet);
  }
  if (theme.includes('lumo')) {
    root.adoptedStyleSheets.push(lumoStyleSheet);
  }
  root.adoptedStyleSheets.push(docsStyleSheet);
}

export function applyTheme(root: DocumentFragment | DocumentOrShadowRoot | HTMLElement) {
  if (root instanceof ShadowRoot) {
    const observer = new MutationObserver(() => updateTheme(root));
    observer.observe(root.host, { attributes: true, attributeFilter: ['theme'] });
    updateTheme(root);
  }
}

export function addStylesheet(css: CSSResultGroup | string) {
  const stylesheet = createStylesheet(css);
  document.adoptedStyleSheets = [...document.adoptedStyleSheets, stylesheet];
}
